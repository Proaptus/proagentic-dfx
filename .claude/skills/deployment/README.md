# Deployment Skill - ProAgentic DfX

Full CI/CD pipeline deployment for the H2 Tank Designer frontend on Vercel.

## Quick Start

**Activate from Claude Code**:
```
User: "Deploy to production"
User: "Run the CI pipeline"
User: "Deploy to staging"
```

**Or run manually**:
```bash
./deploy.sh          # Run full CI pipeline locally
./deploy.sh --quick  # Skip E2E tests for faster validation
```

## The Pipeline

```
File Sizes → Lint/Types → Tests → Build → Mock Server → E2E → Deploy
```

| Step | Command | Time |
|------|---------|------|
| File sizes | `node scripts/check-file-sizes.mjs all` | ~5s |
| Lint | `npm run lint` | ~15s |
| Types | `npx tsc --noEmit` | ~20s |
| Unit tests | `npm run test:coverage` | ~2-3min |
| Build | `npm run build` | ~1-2min |
| Mock server | `cd h2-tank-mock-server && npm test` | ~30s |
| E2E | `npm run test:e2e` | ~3-5min |
| Deploy | Automatic via GitHub Actions | ~1-2min |

**Total**: ~8-14 minutes

## Deployment Targets

| Branch | Environment | URL |
|--------|-------------|-----|
| `main` | Production | https://dfx.proagentic.ai |
| `staging` | Staging | https://proagentic-dfx-staging.vercel.app |
| PR | Preview | Auto-generated by Vercel |

## Prerequisites

### Tools Required

- Node.js 20.x
- npm
- Git
- Playwright browsers (for E2E)

### GitHub Secrets (for CI/CD)

| Secret | Description |
|--------|-------------|
| `VERCEL_TOKEN` | Vercel API token |
| `VERCEL_ORG_ID` | Your Vercel organization ID |
| `VERCEL_PROJECT_ID` | Project ID from Vercel |

### Pre-Flight Checklist

- [ ] On correct branch (`main` for prod, `staging` for staging)
- [ ] Git working directory is clean
- [ ] All dependencies installed (`npm install`)
- [ ] Tests pass locally (`npm test`)

## Usage Examples

### Deploy to Production

```bash
# 1. Ensure you're on main branch
git checkout main
git pull origin main

# 2. Run full CI validation locally
./deploy.sh

# 3. If all gates pass, push to trigger deployment
git push origin main
```

### Deploy to Staging

```bash
# 1. Switch to staging branch
git checkout staging
git merge main  # or your feature branch

# 2. Validate locally
./deploy.sh

# 3. Push to deploy
git push origin staging
```

### Preview Deploy (for PRs)

```bash
# 1. Create feature branch
git checkout -b feature/my-feature

# 2. Make changes and commit
git add .
git commit -m "feat: my new feature"

# 3. Push and create PR
git push origin feature/my-feature
# Open PR in GitHub - preview URL will be posted automatically
```

### Quick Validation (skip E2E)

```bash
./deploy.sh --quick
```

## Quality Gates

### Gate 0: File Size Check

Enforces AI-optimized file sizes:
- Components/Routes: 500 lines max
- Type definitions: 800 lines max
- Test files: 800 lines max

```bash
node ../scripts/check-file-sizes.mjs all
```

### Gate 1: Lint & Type Check

```bash
npm run lint
npx tsc --noEmit
```

### Gate 2: Unit Tests

```bash
npm run test:coverage
```

Target: 80%+ coverage on critical paths

### Gate 3: Build

```bash
npm run build
```

### Gate 4: Mock Server Tests

```bash
cd ../h2-tank-mock-server && npm test
```

### Gate 5: E2E Tests

```bash
npm run test:e2e
```

Required for PRs to `main`.

## Rollback

### Via Vercel Dashboard

1. Navigate to https://vercel.com/dashboard
2. Select proagentic-dfx project
3. Deployments → Find previous working version
4. Click "..." → "Promote to Production"

### Via CLI

```bash
vercel rollback <previous-deployment-url>
```

## Troubleshooting

### Tests Failing

```bash
# Run in watch mode for debugging
npm run test:watch

# Run single test
npm test -- path/to/test.test.ts
```

### Build Errors

```bash
# Check TypeScript errors
npx tsc --noEmit

# Check for missing dependencies
npm install
```

### E2E Failing

```bash
# Run with UI for debugging
npm run test:e2e:ui

# Check report
open playwright-report/index.html
```

### Vercel Issues

```bash
# Check authentication
vercel whoami

# Re-link project
vercel link

# View deployment logs
vercel logs <deployment-url>
```

## Files

```
deployment/
├── SKILL.md           # Full skill documentation
├── README.md          # This file (quick reference)
├── deploy.sh          # Local CI runner script
├── examples/          # Configuration examples
│   ├── deployment-proagentic.config.yml
│   └── sample-deployment-log.json
├── templates/         # Templates
│   └── deployment.config.example.yml
└── archive/           # Old Netlify/Cloud Run configs (deprecated)
```

## CI/CD Workflow File

The actual GitHub Actions workflow is at:
```
.github/workflows/ci.yml
```

This skill's local `deploy.sh` mirrors that pipeline for local validation.

## Migration Notes

### From Old Skill (Netlify/Cloud Run)

The old deployment skill targeted:
- Netlify for frontend
- Google Cloud Run for backend
- Manual UAT testing

The new skill targets:
- Vercel for frontend (no backend in this project)
- Automated testing via Playwright
- GitHub Actions for CI/CD

Old configuration files are archived in `archive/` for reference.
