# ProAgentic DfX - Production Deployment Configuration
#
# Active configuration for the H2 Tank Designer project
# Based on .github/workflows/ci.yml

project: proagentic-dfx
version: "1.0"
last_updated: "2025-12-09"

deployment:
  provider: vercel
  type: frontend-only

  # No backend in this project
  # The mock server (h2-tank-mock-server) is for development only
  backend: null

environments:
  production:
    branch: main
    url: https://dfx.proagentic.ai
    vercel_args: "--prod"
    auto_deploy: true
    requires:
      - unit_tests
      - build
      - mock_server_tests

  staging:
    branch: staging
    url: https://proagentic-dfx-staging.vercel.app
    auto_deploy: true
    requires:
      - unit_tests
      - build
      - mock_server_tests

  preview:
    trigger: pull_request
    url: "auto-generated"
    comment_on_pr: true
    requires:
      - unit_tests
      - build

# GitHub Actions Integration
github_actions:
  workflow_file: ".github/workflows/ci.yml"

  jobs:
    file-sizes:
      runs_on: ubuntu-latest
      command: "node scripts/check-file-sizes.mjs all"

    lint:
      runs_on: ubuntu-latest
      needs: file-sizes
      commands:
        - "npm run lint"
        - "npx tsc --noEmit"
      working_directory: proagentic-dfx

    unit-tests:
      runs_on: ubuntu-latest
      needs: lint
      command: "npm run test:coverage"
      working_directory: proagentic-dfx
      artifacts:
        - name: coverage-report
          path: proagentic-dfx/coverage/
          retention_days: 7

    build:
      runs_on: ubuntu-latest
      needs: lint
      command: "npm run build"
      working_directory: proagentic-dfx
      env:
        NEXT_TELEMETRY_DISABLED: 1
      artifacts:
        - name: build-output
          path: proagentic-dfx/.next/
          retention_days: 1

    mock-server-tests:
      runs_on: ubuntu-latest
      needs: lint
      command: "npm run test"
      working_directory: h2-tank-mock-server

    e2e-tests:
      runs_on: ubuntu-latest
      needs: [build, mock-server-tests]
      condition: "github.event_name == 'pull_request' && github.base_ref == 'main'"
      commands:
        - "npx playwright install --with-deps chromium"
        - "npm run test:e2e"
      working_directory: proagentic-dfx
      artifacts:
        - name: playwright-report
          path: proagentic-dfx/playwright-report/
          retention_days: 7

    security-audit:
      runs_on: ubuntu-latest
      commands:
        - "npm audit --audit-level=high"
      continue_on_error: true

    deploy-preview:
      runs_on: ubuntu-latest
      needs: [unit-tests, build]
      condition: "github.event_name == 'pull_request'"
      uses: amondnet/vercel-action@v25

    deploy-staging:
      runs_on: ubuntu-latest
      needs: [unit-tests, build, mock-server-tests]
      condition: "github.ref == 'refs/heads/staging' && github.event_name == 'push'"
      uses: amondnet/vercel-action@v25

    deploy-production:
      runs_on: ubuntu-latest
      needs: [unit-tests, build, mock-server-tests]
      condition: "github.ref == 'refs/heads/main' && github.event_name == 'push'"
      uses: amondnet/vercel-action@v25
      with:
        vercel_args: "--prod"

# Local Development
local:
  dev_command: "npm run dev"
  dev_port: 3000
  mock_server_port: 8080

# Required Secrets
secrets:
  github:
    - VERCEL_TOKEN
    - VERCEL_ORG_ID
    - VERCEL_PROJECT_ID

# Notes
notes:
  - "This project is frontend-only, deployed to Vercel"
  - "Mock server (h2-tank-mock-server) is for local development only"
  - "E2E tests run only on PRs to main branch"
  - "Production deploys automatically on push to main"
  - "Old Netlify/Cloud Run configs archived in ./archive/"
